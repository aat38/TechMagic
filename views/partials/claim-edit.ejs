<!-- EDIT SPECIFIC CLAIM -->

<% if (locals.claimdata) { %>  
<%- include("header") %>
<% claimdata.forEach(result=>{ %>
<h2>
  Edit Claim
</h2>
Goals for this page: POST changes to appropriate places in db upon submission 


<button  onclick="modal()">Create New Customer</button>

      <form id="updateform" onsubmit="update('<%=result.status%>');">  
        <span><b>Customer: </b><%=result.customer%></span>
        <span><b>Product: </b><%=result.product%> <b>Product Id: </b><%=result.productid%></span>
        <div>
          <b>Issue: </b>
          <select id="issueList">
          <% if (locals.issues) { %> 
            <option value="" disabled selected hidden><%=result.issue%> </option> <!--  keeping the selected issue visible in dropdown box -->
            <% issues.forEach(issue=>{ %>
            <option value='<%=issue.name%>'><%=issue.name %></option>
            <% } )%>
          <% } %>
          </select>
        </div>
        <div>
          <b>Status: </b>
          <select id="status">
            <option value="" disabled selected hidden><%=result.status%></option> <!--  keeping the selected status visible in dropdown box -->
            <%if (result.status==="Closed"){%>
            <option value='Open'>Open</option>
             <% }else{ %>
            <option value='Closed'>Closed</option>
            <% } %>
          </select>
        </div>
        <div>
          <b>Description: </b>
          <input value="<%=result.description%>" id="description" name="description" type="text" >
        </div>
        <div>
          <b>Employee: </b>
          <select id="employeeList">
            <% if (locals.employees) { %> 
              <option value="" disabled selected hidden><%=result.employee%> </option> <!--  keeping the selected employee visible in dropdown box -->
              <% employees.forEach(employee=>{ %>
              <option value='<%=employee.lastname%>'><%=employee.firstname %> <%=employee.lastname%></option>
               <% } )%>
            <% } %>
          </select>
        </div>
        <% if (locals.comments) { %>  
        <div>
         <b>Comments: </b>
          <table class="table table-striped table-bordered">
            <thead>
              <tr>
                <th>Comment</th>
                <th>Commenter</th>
              </tr>
            </thead>
            <tbody>
            <% comments.forEach(comment=>{ %>
              <tr>
                <td><%=comment.description%></td>
                <td>
                  <% if (locals.employees){%>
                  <% if (locals.comments){%>
                  <% if (comment.employeeid>0){%>
                    <%=employees[comment.employeeid-1].firstname%> 
                    <%=employees[comment.employeeid-1].lastname%>
                  <%}else{%>
                    <%=employees[0].firstname%> 
                    <%=employees[0].lastname%>
                  <%}%>
                  <%}%>
                  <%}%>
                </td>
              </tr>
            <%})%>
            </tbody>
          </table>
        </div>
        <%}%>
        <% if (locals.resolutions) { %>  
        <div>
          <b>Resolution: </b>
          <select id="resolutionList">
             <!--  keeping the selected letter visible in dropdown box -->
              <option value="" disabled selected hidden><%=result.resolution%> </option> <!--  keeping the selected resolution visible in dropdown box -->
              <% resolutions.forEach(resolution=>{ %>
              <option value='<%=resolution.name%>'><%=resolution.name%></option>
              <% } )%>
          </select>
        </div>
        <% } %>
        <div>
          <b>Date Opened: </b> 
          <%=result.dateopened%>
        </div>
        <div>
          <b>Date Closed: </b>
          <%=result.dateopened%>
        </div>
        <input type="submit">
      </form>

<script type=text/javascript>
  //if comments, add comment
  //else update     "UPDATE claim SET issue = $1, status= $2, description =$3, employee=$4, dateopened=$5, resolution=$6, dateclosed = $7 WHERE claimid = $8";
  function update(ele){
    var changedStatus
    //if open->open || if close->close
    if (ele===document.getElementById("status").value){
      changedStatus=false;
    }
    //if open->close || if close->open 
    if (ele===document.getElementById("status").value){
      changedStatus=false;
    }
    

    
    fetch('https://ejs-views-practice.glitch.me/api/claims/admin", {
          headers:{
            "content-type":"application/json",
          },
          body: JSON.stringify({
            issue:document.getElementById("issueList").value,
            status:document.getElementById("status").value,
            description:document.getElementById("description").value,
            employee:document.getElementById("employeeList").value,
            dateopened:document.getElementById("       ").value,
            resolution:document.getElementById("resolutionList").value,
            dateclosed:document.getElementById("      ").value,
            changedStatus: changedStatus
          }),
              method: 'POST'
          }).then(resp=>{
          }, err=>{
            console.log(err);
          })
        location = location //refresh
    }
  }
</script>

<%})%>
<%- include("footer") %>
<%}%>


