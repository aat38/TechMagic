<%- include("partials/header") %>
<!-- need to import purchase and productPurchase tables -->


<% if (locals.customers){%>
<h1>Orders</h1>
<%- include("partials/vieworder") %>
<p>
  Goals for this page: create purchases(orders), create claims based on purchases, view purchases âœ“
</p>

<button onclick="orderModal()">Create Order</button>

<table id="table" class="table table-hover">
  <thead>
    <tr>
      <th></th>
      <th>Order Number</th>
      <th>Customer</th>
      <th>Total Price</th>
      <th>Date</th>
    </tr>
  </thead>
  <% purchase.forEach(result=>{ %>
  <% var datePurchase = new Date(result.date) %>
  <% var datePurchase = (datePurchase.getMonth()+1) + "/" + datePurchase.getDate() + "/" +  datePurchase.getFullYear() %>

  <tbody>
    <tr>
      <td><button><a href="/purchases/<%=result.purchaseid%>">View Order</a></button></td>
      <td><%=result.purchaseid%></td>
      <td><%=customers[result.customerid-1].firstname%> <%=customers[result.customerid-1].lastname%></td>
      <td><%=result.totalcost%></td>
      <td><%=datePurchase%></td>
     </tr> 
  </tbody>
  <%})%>
</table>

<!--  Create Order Modal  (need customer list and product list)-->
  <div id="createOrderModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span><!-- close button -->
      <div class="d-flex justify-content-center flex-column">
        <form id="createform"> 
          <div>
            <b>Customer: </b>
            <select id="customerList">
            <% if (locals.customers) { %> 
              <% customers.forEach(customer=>{ %>
              <option value='<%=customer.customerid%>'><%=customer.firstname %> <%=customer.lastname %></option>
              <% } )%>
            <% } %>
            </select>
          </div>
          <b>Products Purchased:</b>
          <div id="product">
            <select id="productList">
            <% if (locals.products) { %> 
              <% products.forEach(product=>{ %>
              <option value='<%=product.productid%>;<%=product.unitcost%>'><%=product.name%></option>
              <% } )%>
            <% } %>
            </select>
          </div>          
          <% if (locals.products) { %> 
              <% var nameArr=[]%>
              <% var idArr=[]%>
              <% products.forEach(product=>{ %>
              <% nameArr.push(product.name)%>
              <% idArr.push(product.productid)%>
              <% } )%>
            <% } %>
          <div><p id="para" onclick="createProductDiv('<%=nameArr%>','<%=idArr%>');">+ Add Product</p></div>
          <button  onclick="addProducts();">Submit New Order</button>
        </form>
      </div>
    </div>
  </div>


<%}else{%>
<h1>
 No Orders Found
</h1>
<%}%>

<script>
  var count=0;
  document.getElementById("para").addEventListener("click", function(){count=+1});

  
  function addProducts(){
    
  }
  
  function createProductDiv(productnames, productids){
    var div = document.createElement('div')
    var select = document.createElement('select');
    select.setAttribute("id", count);
    document.getElementById("product").appendChild(div)
    div.appendChild(select);
    productnames = (productnames.split(","))
    productids = (productids.split(","))
    for (var i = 0; i<productnames.length; i++){
      var option = document.createElement("option");
      option.setAttribute("value", productids[i]);
      var optiontext = document.createTextNode(productnames[i]);
      option.appendChild(optiontext);
      document.getElementById(count).appendChild(option);
    }
  }
  
  function orderModal() {

      var modal = document.getElementById("createOrderModal"); 
      var closeBtn = document.getElementsByClassName("close")[0];
      modal.style.display = "block";
      //close out of modal either when clicking 'x' 
      closeBtn.onclick = function() {
        modal.style.display = "none";
        location=location;
      }
      //or close modal when clicking outside of the modal
      // window.onclick = function(event) {
      //   if (event.target == modal || !modal.contains(event.target)) {
      //   modal.style.display = "none";
      //   }
      // }
  } 

</script>




<%- include("partials/footer") %>